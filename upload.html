<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Subir Foto | Fasago Fotos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <nav>
      <a href="home.html">Inicio</a>
      <a href="gallery.html">Galería</a>
      <a href="upload.html" class="active">Subir foto</a>
      <button onclick="logout()">Cerrar sesión</button>
    </nav>
  </header>

  <main class="upload-main">
    <h1>Subir Nueva Foto</h1>
    <form id="uploadForm">
      <div class="form-group">
        <label for="photoUpload">Seleccionar imagen (max 5MB):</label>
        <input type="file" id="photoUpload" accept="image/*" required>
      </div>
      <div id="previewContainer" class="preview-container">
        <img id="imagePreview">
      </div>
      <button type="submit" id="uploadBtn">Subir Foto</button>
      <div id="uploadStatus" class="status-message"></div>
    </form>
  </main>

  <script type="module">
    import { auth, storage } from './firebase.js';
    import { ref, uploadBytes, getDownloadURL } from "firebase/storage";
    import { onAuthStateChanged, signOut } from "firebase/auth";

    // Vista previa
    document.getElementById('photoUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.size <= 5 * 1024 * 1024) { // 5MB max
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('imagePreview').src = event.target.result;
          document.getElementById('previewContainer').style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else if (file) {
        alert('La imagen es demasiado grande (máx 5MB)');
        e.target.value = '';
      }
    });

    // Subir archivo
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('photoUpload').files[0];
      const user = auth.currentUser;

      if (!file || !user) return;

      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'Subiendo... <span class="spinner"></span>';

      try {
        const storageRef = ref(storage, `photos/${user.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);
        
        document.getElementById('uploadStatus').textContent = '¡Foto subida con éxito!';
        document.getElementById('uploadStatus').style.color = 'green';
        document.getElementById('uploadForm').reset();
        document.getElementById('previewContainer').style.display = 'none';
      } catch (error) {
        document.getElementById('uploadStatus').textContent = `Error: ${error.message}`;
        document.getElementById('uploadStatus').style.color = 'red';
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Subir Foto';
      }
    });

    // Verificar autenticación
    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = 'login.html';
    });

    window.logout = () => signOut(auth);
  </script>
</body>
</html>
